package me.bebeli555.cookieclient.mods.exploits;

import me.bebeli555.cookieclient.Mod;
import me.bebeli555.cookieclient.events.bus.EventHandler;
import me.bebeli555.cookieclient.events.bus.Listener;
import me.bebeli555.cookieclient.events.other.PacketEvent;
import me.bebeli555.cookieclient.events.other.PacketPostEvent;
import me.bebeli555.cookieclient.gui.Group;
import me.bebeli555.cookieclient.gui.Mode;
import me.bebeli555.cookieclient.gui.Setting;
import me.bebeli555.cookieclient.mods.combat.Surround;
import me.bebeli555.cookieclient.mods.misc.Debug;
import me.bebeli555.cookieclient.utils.BlockUtil;
import me.bebeli555.cookieclient.utils.InventoryUtil;
import me.bebeli555.cookieclient.utils.InventoryUtil.ItemStackUtil;
import me.bebeli555.cookieclient.utils.RotationUtil;
import net.minecraft.block.Block;
import net.minecraft.init.Blocks;
import net.minecraft.item.ItemBlock;
import net.minecraft.network.play.client.CPacketConfirmTeleport;
import net.minecraft.network.play.client.CPacketPlayer;
import net.minecraft.network.play.server.SPacketPlayerPosLook;
import net.minecraft.util.EnumFacing;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.Vec3d;
import net.minecraftforge.common.MinecraftForge;
import net.minecraftforge.fml.common.eventhandler.SubscribeEvent;
import net.minecraftforge.fml.common.gameevent.TickEvent.ClientTickEvent;

public class Burrow extends Mod {
	public static Burrow instance;
	private static boolean done;
	private static Block placeBlock;
	private static int oldSlot;
	
	public static Setting mode = new Setting(null, "Mode", "Instant", new String[]{"Instant", "Places the block instantly"}, new String[]{"Jump", "Jumps and places the block"});
		public static Setting delay = new Setting(mode, "Jump", Mode.INTEGER, "Delay", 250, "Delay in ms to wait after the first jump", "To placing the block and second jump");
		public static Setting height = new Setting(mode, "Instant", Mode.DOUBLE, "Height", 10, "How many blocks to teleport to set direction after placing", "The block to trigger the anticheat");
		public static Setting upDirection = new Setting(mode, "Instant", Mode.BOOLEAN, "Up", true, "Teleports you up to trigger the anticheat", "If false then on horizontal direction");
		public static Setting selectFreeDirection = new Setting(mode, "Instant", Mode.BOOLEAN, "2b2t", false, "Does some stuff that prevents getting kicked on 2b2t", "If you have this enabled the 2 settings above wont do anything");
	public static Setting center = new Setting(Mode.BOOLEAN, "Center", true, "Centers you in the middle of the block before doing the thing");
	public static Setting enderChest = new Setting(Mode.BOOLEAN, "EnderChest", false, "Uses only enderchests to burrow");
	public static Setting cancelRotation = new Setting(Mode.BOOLEAN, "CancelRotation", true, "Cancels server force rotation after using it");

	public Burrow() {
		super(Group.EXPLOITS, "Burrow", "Glitches you inside obsidian");
		this.autoSubscribe = false;
		instance = this;
	}
	
	@Override
	public void onEnabled() {
		if (mc.player == null) {
			disable();
			return;
		}
		
		if (isSolid(getPlayerPos())) {
			sendMessage("You are already burrowed", true);
			disable();
			return;
		}
		
		new Thread() {
			public void run() {		
				Block block = null;
				
				//If the player has obsidian then use that as its the best
				if (InventoryUtil.hasBlock(Blocks.OBSIDIAN)) {
					block = Blocks.OBSIDIAN;
				} else {
					//First search the hotbar for blocks
					for (int i = 0; i < 9; i++) {
						if (InventoryUtil.getItemStack(i).getItem() instanceof ItemBlock) {
							block = Block.getBlockFromItem(InventoryUtil.getItemStack(i).getItem());
							break;
						}
					}
					
					//Then search the entire inventory if no blocks were in hotbar
					if (block == null) {
						for (ItemStackUtil itemStack : InventoryUtil.getAllItems()) {
							if (itemStack.itemStack.getItem() instanceof ItemBlock) {
								block = Block.getBlockFromItem(itemStack.itemStack.getItem());
								break;
							}
						}
					}
				}
				
				if (enderChest.booleanValue()) {
					if (InventoryUtil.hasBlock(Blocks.ENDER_CHEST)) {
						block = Blocks.ENDER_CHEST;
					} else {
						block = null;
					}
				}
				
				if (block == null) {
					sendMessage("You dont have any placeable block", true);
					disable();
					return;
				}
				
				//Switch to block
				oldSlot = mc.player.inventory.currentItem;
				
				//Center
				if (center.booleanValue()) {
					Surround.centerMotionFull();
				}
				
				//Instant mode. this is run on the minecraft thread.
				if (mode.stringValue().equals("Instant")) {
					placeBlock = block;
					MinecraftForge.EVENT_BUS.register(instance);
					sleepUntil(() -> done, 200, 5);
				} 
				
				//Jump mode
				else if (mode.stringValue().equals("Jump")) {
					BlockPos start = getPlayerPos();
					mc.player.jump();
					Mod.sleep(delay.intValue());
					InventoryUtil.switchItem(InventoryUtil.getSlot(block), false);
					BlockUtil.placeBlock(block, start, true);
					mc.player.jump();
					mc.player.inventory.currentItem = oldSlot;
				}
				
				//Cancel force rotation from server
				if (cancelRotation.booleanValue()) {
					Mod.EVENT_BUS.subscribe(instance);
				}
				disable();
			}
		}.start();
	}
	
	@Override
	public void onDisabled() {
		done = false;
		placeBlock = null;
		RotationUtil.stopRotating();
	}
	
	@SubscribeEvent
	public void onTick(ClientTickEvent e) {
		BlockPos start = getPlayerPos();
        mc.player.connection.sendPacket(new CPacketPlayer.Position(mc.player.posX, mc.player.posY + 0.41999998688698D, mc.player.posZ, true));
        mc.player.connection.sendPacket(new CPacketPlayer.Position(mc.player.posX, mc.player.posY + 0.7531999805211997D, mc.player.posZ, true));
        mc.player.connection.sendPacket(new CPacketPlayer.Position(mc.player.posX, mc.player.posY + 1.00133597911214D, mc.player.posZ, true));
        mc.player.connection.sendPacket(new CPacketPlayer.Position(mc.player.posX, mc.player.posY + 1.16610926093821D, mc.player.posZ, true));
        mc.player.setPosition(mc.player.posX, mc.player.posY + 1.16610926093821D, mc.player.posZ);

		InventoryUtil.switchItem(InventoryUtil.getSlot(placeBlock), false);
        BlockUtil.placeBlockOnThisThread(placeBlock, start, true);
        mc.player.setPosition(mc.player.posX, start.getY(), mc.player.posZ);

		if (selectFreeDirection.booleanValue()) {
			//If on 2b2t mode then it selects a height and a direction that lands on an air block
			//This way the anticheat will allow the burrow and you wont get kicked for too big height
			//With too little height you cant use it as theres no free spot if your for example close to the nether roof
			outer: for (int i = 2; i < 11; i++) {
				for (EnumFacing facing : EnumFacing.values()) {
					if (facing != EnumFacing.DOWN) {
						Vec3d player = new Vec3d(mc.player.posX, mc.player.posY, mc.player.posZ);
						if (facing == EnumFacing.UP) {
							player = player.add(0, i, 0);
						} else if (facing == EnumFacing.EAST) {
							player = player.add(i, 0, 0);
						} else if (facing == EnumFacing.SOUTH) {
							player = player.add(0, 0, i);
						} else if (facing == EnumFacing.WEST) {
							player = player.add(-i, 0, 0);
						} else if (facing == EnumFacing.NORTH) {
							player = player.add(0, 0, -i);
						}

						if (!isSolid(new BlockPos(player)) && !isSolid(new BlockPos(player.add(0, 1, 0))) && !isSolid(new BlockPos(player.add(0, 2, 0)))) {
							mc.player.connection.sendPacket(new CPacketPlayer.Position(player.x, player.y, player.z, false));
							Debug.debug("Burrow 2b2t chose pos: " + player + " Height: " + i);
							break outer;
						}
					}
				}
			}
		} else {
			if (upDirection.booleanValue()) {
				mc.player.connection.sendPacket(new CPacketPlayer.Position(mc.player.posX, mc.player.posY + height.doubleValue(), mc.player.posZ, false));
			} else {
				mc.player.connection.sendPacket(new CPacketPlayer.Position(mc.player.posX + height.doubleValue(), mc.player.posY, mc.player.posZ, false));
			}
		}

		InventoryUtil.switchItem(oldSlot, false);

        MinecraftForge.EVENT_BUS.unregister(instance);
        done = true;
	}

    @EventHandler
    private Listener<PacketEvent> packetEvent = new Listener<>(event -> {
    	if (mc.player == null) {
			Mod.EVENT_BUS.unsubscribe(instance);
			return;
    	}
    	
    	if (event.packet instanceof SPacketPlayerPosLook) {
    		event.cancel();
    		
    		SPacketPlayerPosLook packet = (SPacketPlayerPosLook)event.packet;
    		mc.player.motionY = 0;
    		
            mc.player.connection.sendPacket(new CPacketConfirmTeleport(packet.getTeleportId()));
            mc.player.connection.sendPacket(new CPacketPlayer.PositionRotation(mc.player.posX, packet.getY(), mc.player.posZ, packet.getYaw(), packet.getPitch(), false));
            
			Mod.EVENT_BUS.unsubscribe(instance);
    	}
    });
}
